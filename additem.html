<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ–°å¢å•†å“</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      max-width: 100%;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f6f6f6;
    }
    *, *::before, *::after { box-sizing: border-box; }

    .header {
      background: #111;
      color: #fff;
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 18px;
      margin: 0;
    }

    .back-btn {
      background: #444;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .back-btn:hover {
      background: #666;
    }

    .container { 
      padding: 14px; 
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 14px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .reference-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      font-size: 13px;
    }

    .reference-column {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .reference-item {
      padding: 4px 8px;
      background: #f9f9f9;
      border-radius: 4px;
      color: #333;
      font-family: 'Courier New', monospace;
      white-space: pre;
      text-align: left;
    }


    .form-section {
      margin-bottom: 16px;
    }

    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: flex-end;
    }

    .form-field {
      display: flex;
      flex-direction: column;
    }

    .form-field label {
      font-size: 13px;
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .form-field input,
    .form-field select {
      width: 200px;
      font-size: 14px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 0;
      background: #fff;
    }
    

    .status-msg {
      margin-top: 8px;
      font-size: 13px;
      text-align: center;
    }

    .suggest-btn {
      padding: 8px 12px;
      background: #666;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      height: 34px;
    }

    .suggest-btn:hover {
      background: #888;
    }

    .product-code-card {
      width: calc(60% + 4px);
      max-width: none;
      margin-right: auto;
    }

    .product-code-row {
      display: flex;
      gap: 4px;
      align-items: flex-end;
      margin-bottom: 16px;
    }

    .product-category-field {
      flex: 0 0 120px;
      min-width: 120px;
    }

    .product-name-field {
      flex: 1;
      min-width: 0;
    }

    .product-name-field input {
      width: 100%;
    }

    .product-code-row .form-field select,
    .product-code-row .form-field input {
      width: 100%;
    }

    .product-code-card .form-row select {
      width: 140px;
    }

    .product-price-field input {
      width: 120px;
    }

    .product-generate-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    .product-code-output {
      padding: 8px 10px;
      background: #f1f8e9;
      border: 1px solid #c5e1a5;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      color: #33691e;
      min-width: 120px;
    }

    .product-summary {
      margin-top: 6px;
      font-size: 13px;
      white-space: pre-line;
      color: #333;
    }

    .code-create-card {
      width: 30%;
      max-width: none;
      margin-right: 0;
    }

    .reference-card {
      width: 30%;
      flex: none;
      max-width: none;
    }

    .code-reference-row {
      display: flex;
      gap: 4px;
      align-items: flex-start;
    }

    .code-create-row {
      display: flex;
      gap: 2px;
      margin-bottom: 12px;
      align-items: flex-end;
    }

    .code-create-row .form-field {
      flex: 1;
      min-width: 0;
    }

    .code-create-row .form-field input {
      width: 100%;
    }

    #createCodeValue {
      width: 120px;
    }

    .code-create-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .code-create-status {
      text-align: left;
    }

    @media (max-width: 900px) {
      .code-reference-row {
        flex-direction: column;
      }

      .product-code-card,
      .code-create-card,
      .reference-card {
        width: 100%;
      }
    }
  </style>
</head>

<body>

<div class="header">
  <h1>æ–°å¢å•†å“</h1>
  <a href="index.html" class="back-btn">â† è¿”å›</a>
</div>

<div class="container">
  <div class="card product-code-card">
    <div class="form-section">
      <h3 style="font-size: 16px; margin: 0 0 12px 0; color: #111;">æ–°å¢å•†å“ç·¨è™Ÿ</h3>
      <div class="product-code-row">
        <div class="form-field product-category-field">
          <label>åˆ†é¡</label>
          <select id="newProductCategory">
            <option value="" selected>è«‹é¸æ“‡</option>
          </select>
        </div>
        <div class="form-field product-name-field">
          <label>å•†å“åç¨±</label>
          <input id="newProductName" type="text" list="newProductNameList" placeholder="é¸æ“‡æˆ–è¼¸å…¥">
          <datalist id="newProductNameList"></datalist>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>é¡è‰²</label>
          <select id="newProductColor">
            <option value="" selected>è«‹é¸æ“‡</option>
          </select>
        </div>
        <div class="form-field">
          <label>å¤§å°</label>
          <select id="newProductSize">
            <option value="" selected>è«‹é¸æ“‡</option>
          </select>
        </div>
        <div class="form-field product-price-field">
          <label>åƒ¹æ ¼</label>
          <input id="newProductPrice" type="number" placeholder="è¼¸å…¥åƒ¹æ ¼" inputmode="numeric">
        </div>
        <div class="code-create-actions">
          <button class="suggest-btn" type="button" onclick="generateNewProductCode()">ç”Ÿæˆ</button>
        </div>
      </div>
      <div class="product-generate-row">
        <div class="form-field">
          <label>å•†å“ç·¨è™Ÿ</label>
          <div class="product-code-output" id="newProductCodeOutput">â€”</div>
        </div>
      </div>
      <div class="product-summary" id="newProductSummary"></div>
      <div class="status-msg" id="newProductStatus"></div>
    </div>
  </div>

  <div class="code-reference-row">
    <div class="card code-create-card">
      <div class="form-section">
        <h3 style="font-size: 16px; margin: 0 0 12px 0; color: #111;">å‰µå»ºä»£è™Ÿ</h3>
        <div class="form-row" style="align-items: flex-end;">
          <div class="form-field">
            <label>é¡å‹</label>
            <select id="createCodeType">
              <option value="" selected>è«‹é¸æ“‡</option>
              <option value="category">åˆ†é¡</option>
              <option value="color">é¡è‰²</option>
              <option value="size">å¤§å°</option>
            </select>
          </div>
        </div>
        <div class="code-create-row">
          <div class="form-field">
            <label>ä»£è™Ÿ</label>
            <input id="createCodeValue" type="text" placeholder="è¼¸å…¥ä»£è™Ÿ" maxlength="2">
          </div>
          <div class="form-field">
            <label>æè¿°</label>
            <input id="createCodeDesc" type="text" placeholder="è¼¸å…¥æè¿°">
          </div>
        </div>
        <div class="form-row" style="align-items: center;">
          <div class="code-create-actions">
            <button class="suggest-btn" type="button" onclick="submitCodeEntry()">æ–°å¢ä»£è™Ÿ</button>
          </div>
        </div>
        <div class="status-msg code-create-status" id="codeCreateStatus"></div>
      </div>
    </div>

    <!-- Reference Codes Section -->
    <div class="card reference-card">
      <h3 style="font-size: 16px; margin: 0 0 12px 0; color: #111;">ğŸ“š ä»£è™Ÿå°ç…§è¡¨</h3>
      <div class="reference-grid" id="referenceData">
        <div class="loading">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>
</div>

<script>

const API_URL = "https://sales-v1-api-26316719641.asia-east1.run.app"; // â† è«‹æ”¹æˆæ‚¨çš„ Cloud Run URL

// === Helper Functions ===
function token() { 
  return localStorage.getItem("sessionToken"); 
}

async function apiCall(action, method = "GET", body = null) {
  const options = {
    method: method,
    headers: {
      "Content-Type": "application/json",
      "x-session-token": token()
    }
  };
  
  if (body) {
    options.body = JSON.stringify(body);
  }
  
  const url = action.startsWith("?") ? API_URL + action : API_URL + "?action=" + action;
  
  const response = await fetch(url, options);
  return await response.json();
}

// === Load Reference Maps from ä»£è™Ÿåå–® ===
async function loadReferenceMaps() {
  try {
    const data = await apiCall("?action=get_sheet_data&sheet=ä»£è™Ÿåå–®&range=A1:F");
    
    if (data.error || !data.values || data.values.length === 0) {
      return;
    }

    const colorOptions = [];
    const sizeOptions = [];
    const colorCodeMap = {};
    const sizeCodeMap = {};

    for (let i = 1; i < data.values.length; i++) {
      const row = data.values[i];

      if (row[2] && row[3]) {
        const colorName = row[2];
        const colorCode = row[3];
        const display = `${colorCode}-${colorName}`;
        colorOptions.push(display);
        colorCodeMap[display] = colorCode;
        colorCodeMap[colorName] = colorCode;
      }

      if (row[4] && row[5]) {
        const sizeName = row[4];
        const sizeCode = row[5];
        const display = `${sizeCode}-${sizeName}`;
        sizeOptions.push(display);
        sizeCodeMap[display] = sizeCode;
        sizeCodeMap[sizeName] = sizeCode;
      }
    }

    window.newProductColorOptions = colorOptions;
    window.newProductSizeOptions = sizeOptions;
    window.newProductColorCodeMap = colorCodeMap;
    window.newProductSizeCodeMap = sizeCodeMap;
    populateNewProductOptions();

    // Display reference data table
    displayReferenceData(data.values);
  } catch (error) {
    console.error('Error loading reference maps:', error);
  }
}

function populateNewProductOptions() {
  const colorEl = document.getElementById('newProductColor');
  const sizeEl = document.getElementById('newProductSize');
  if (!colorEl || !sizeEl) {
    return;
  }

  const colorOptions = window.newProductColorOptions || [];
  const sizeOptions = window.newProductSizeOptions || [];

  colorEl.innerHTML = '<option value="" selected>è«‹é¸æ“‡</option>' +
    colorOptions.map(option => `<option value="${option}">${option}</option>`).join('');
  sizeEl.innerHTML = '<option value="" selected>è«‹é¸æ“‡</option>' +
    sizeOptions.map(option => `<option value="${option}">${option}</option>`).join('');
}

// === Display Reference Data Table ===
function displayReferenceData(values) {
  const container = document.getElementById('referenceData');
  
  if (!values || values.length === 0) {
    container.innerHTML = '<div style="color: #999;">ç„¡è³‡æ–™</div>';
    return;
  }
  
  // Organize data by columns
  const categories = [];
  const colors = [];
  const sizes = [];
  
  // Skip header (index 0), process from index 1
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    
    // Column A-B: ä»£è™Ÿ-åˆ†é¡
    if (row[0] && row[1]) {
      categories.push(`${row[1]}-${row[0]}`);
    }
    
    // Column C-D: ä»£è™Ÿ-é¡è‰²
    if (row[2] && row[3]) {
      colors.push(`${row[3]}-${row[2]}`);
    }
    
    // Column E-F: ä»£è™Ÿ-å¤§å°
    if (row[4] && row[5]) {
      sizes.push(`${row[5]}-${row[4]}`);
    }
  }
  
  // Build 3-column layout
  let html = '';
  
  if (categories.length > 0) {
    html += '<div class="reference-column">';
    html += '<div style="font-weight: bold; margin-bottom: 8px; color: #111;">åˆ†é¡</div>';
    categories.forEach(item => {
      html += `<div class="reference-item">${item}</div>`;
    });
    html += '</div>';
  }
  
  if (colors.length > 0) {
    html += '<div class="reference-column">';
    html += '<div style="font-weight: bold; margin-bottom: 8px; color: #111;">é¡è‰²</div>';
    colors.forEach(item => {
      html += `<div class="reference-item">${item}</div>`;
    });
    html += '</div>';
  }
  
  if (sizes.length > 0) {
    html += '<div class="reference-column">';
    html += '<div style="font-weight: bold; margin-bottom: 8px; color: #111;">å¤§å°</div>';
    sizes.forEach(item => {
      html += `<div class="reference-item">${item}</div>`;
    });
    html += '</div>';
  }
  
  container.innerHTML = html;
}


// === Add Code Entry ===
async function submitCodeEntry() {
  const type = document.getElementById('createCodeType').value;
  const codeInputEl = document.getElementById('createCodeValue');
  const code = codeInputEl.value.trim().toUpperCase();
  const desc = document.getElementById('createCodeDesc').value.trim();
  const statusEl = document.getElementById('codeCreateStatus');

  if (!type) {
    statusEl.innerHTML = '<span style="color: red;">è«‹é¸æ“‡é¡å‹</span>';
    return;
  }

  if (!code || !desc) {
    statusEl.innerHTML = '<span style="color: red;">è«‹å¡«å¯«ä»£è™Ÿèˆ‡æè¿°</span>';
    return;
  }

  if (type === 'category' && !/^[A-Z]{2}$/.test(code)) {
    statusEl.innerHTML = '<span style="color: red;">åˆ†é¡ä»£è™Ÿéœ€ç‚º 2 å€‹å­—æ¯</span>';
    return;
  }

  if ((type === 'color' || type === 'size') && !/^[A-Z]{1}$/.test(code)) {
    statusEl.innerHTML = '<span style="color: red;">ä»£è™Ÿéœ€ç‚º 1 å€‹å­—æ¯</span>';
    return;
  }

  codeInputEl.value = code;

  try {
    statusEl.innerHTML = 'æ–°å¢ä¸­...';

    const result = await apiCall('addCodeEntry', 'POST', {
      type,
      code,
      desc
    });

    if (result.error) {
      statusEl.innerHTML = `<span style="color: red;">éŒ¯èª¤: ${result.error}</span>`;
      return;
    }

    statusEl.innerHTML = '<span style="color: green;">ä»£è™Ÿæ–°å¢æˆåŠŸï¼</span>';

    document.getElementById('createCodeValue').value = '';
    document.getElementById('createCodeDesc').value = '';

    await loadReferenceMaps();

    setTimeout(() => {
      statusEl.innerHTML = '';
    }, 2000);
  } catch (error) {
    statusEl.innerHTML = `<span style="color: red;">æ–°å¢å¤±æ•—: ${error.message}</span>`;
  }
}

function updateCodeConstraints() {
  const typeEl = document.getElementById('createCodeType');
  const codeEl = document.getElementById('createCodeValue');
  const type = typeEl.value;

  if (type === 'category') {
    codeEl.maxLength = 2;
    codeEl.placeholder = 'è¼¸å…¥2å­—æ¯';
  } else if (type === 'color' || type === 'size') {
    codeEl.maxLength = 1;
    codeEl.placeholder = 'è¼¸å…¥1å­—æ¯';
  } else {
    codeEl.maxLength = 2;
    codeEl.placeholder = 'è¼¸å…¥ä»£è™Ÿ';
  }
}

function normalizeCodeInput() {
  const codeEl = document.getElementById('createCodeValue');
  let value = codeEl.value.toUpperCase().replace(/[^A-Z]/g, '');
  const maxLength = codeEl.maxLength || 2;
  if (value.length > maxLength) {
    value = value.slice(0, maxLength);
  }
  codeEl.value = value;
}

function buildProductNameIndex(products) {
  const map = {};

  (products || []).forEach(product => {
    const code = (product.code || '').trim();
    const name = (product.name || '').trim();
    if (!code || code.length < 2 || !name) {
      return;
    }

    const prefix = code.substring(0, 2).toUpperCase();
    if (!map[prefix]) {
      map[prefix] = new Set();
    }
    map[prefix].add(name);
  });

  const result = {};
  Object.keys(map).forEach(prefix => {
    result[prefix] = Array.from(map[prefix]).sort();
  });

  return result;
}

function updateProductNameOptions(index) {
  const categoryEl = document.getElementById('newProductCategory');
  const datalistEl = document.getElementById('newProductNameList');
  const selected = (categoryEl.value || '').toUpperCase();
  const names = index[selected] || [];
  datalistEl.innerHTML = names.map(name => `<option value="${name}"></option>`).join('');
}

function extractCodeFromOption(value, map) {
  if (!value) {
    return '';
  }

  if (map && map[value]) {
    return map[value];
  }

  if (value.includes('-')) {
    return value.split('-')[0];
  }

  return value;
}

function extractNameFromOption(value) {
  if (!value) {
    return '';
  }

  if (value.includes('-')) {
    return value.split('-').slice(1).join('-');
  }

  return value;
}

function generateNewProductCode() {
  const categoryCode = (document.getElementById('newProductCategory').value || '').trim().toUpperCase();
  const productName = (document.getElementById('newProductName').value || '').trim();
  const colorValue = document.getElementById('newProductColor').value;
  const sizeValue = document.getElementById('newProductSize').value;
  const priceValue = (document.getElementById('newProductPrice').value || '').trim();
  const outputEl = document.getElementById('newProductCodeOutput');
  const statusEl = document.getElementById('newProductStatus');
  const summaryEl = document.getElementById('newProductSummary');

  statusEl.textContent = '';
  summaryEl.textContent = '';

  if (!categoryCode || categoryCode.length < 2) {
    outputEl.textContent = 'è«‹é¸æ“‡åˆ†é¡';
    return;
  }

  if (!productName) {
    outputEl.textContent = 'è«‹è¼¸å…¥å•†å“åç¨±';
    return;
  }

  if (!colorValue || !sizeValue) {
    outputEl.textContent = 'è«‹é¸æ“‡é¡è‰²èˆ‡å¤§å°';
    return;
  }

  if (!priceValue || isNaN(Number(priceValue))) {
    outputEl.textContent = 'è«‹è¼¸å…¥åƒ¹æ ¼';
    return;
  }

  const products = window.cachedProducts || [];
  const categoryProducts = products.filter(p => {
    const code = (p.code || '').toString().toUpperCase();
    return code.startsWith(categoryCode);
  });

  let numberPart = '001';
  if (productName) {
    const sameName = categoryProducts.filter(p => (p.name || '') === productName);
    if (sameName.length > 0) {
      const numbers = sameName
        .map(p => (p.code || '').toString().substring(2, 5))
        .map(value => parseInt(value, 10))
        .filter(value => !isNaN(value));
      if (numbers.length > 0) {
        const maxNumber = Math.max(...numbers);
        numberPart = maxNumber.toString().padStart(3, '0');
      }
    } else if (categoryProducts.length > 0) {
      const numbers = categoryProducts
        .map(p => (p.code || '').toString().substring(2, 5))
        .map(value => parseInt(value, 10))
        .filter(value => !isNaN(value));
      if (numbers.length > 0) {
        const maxNumber = Math.max(...numbers) + 1;
        numberPart = maxNumber.toString().padStart(3, '0');
      }
    }
  } else if (categoryProducts.length > 0) {
    const numbers = categoryProducts
      .map(p => (p.code || '').toString().substring(2, 5))
      .map(value => parseInt(value, 10))
      .filter(value => !isNaN(value));
    if (numbers.length > 0) {
      const maxNumber = Math.max(...numbers) + 1;
      numberPart = maxNumber.toString().padStart(3, '0');
    }
  }

  const colorCode = extractCodeFromOption(colorValue, window.newProductColorCodeMap);
  const sizeCode = extractCodeFromOption(sizeValue, window.newProductSizeCodeMap);
  const finalCode = `${categoryCode}${numberPart}${colorCode}${sizeCode}`;

  const categoryNameMap = window.categoryCodeNameMap || {};
  const categoryName = categoryNameMap[categoryCode] || categoryCode;
  const colorName = extractNameFromOption(colorValue);
  const sizeName = extractNameFromOption(sizeValue);

  outputEl.textContent = finalCode;

  summaryEl.textContent = `${productName}ï½œ${colorName}ï½œ${sizeName}ï½œ${priceValue}ï½œ${categoryName}`;

  apiCall('addProduct', 'POST', {
    code: finalCode,
    name: productName,
    color: colorName,
    size: sizeName,
    price: priceValue,
    category: categoryName
  }).then(result => {
    if (result.error) {
      statusEl.innerHTML = `<span style="color: red;">éŒ¯èª¤: ${result.error}</span>`;
      return;
    }

    if (result.status === 'exists' && result.existing) {
      const existing = result.existing;
      outputEl.textContent = existing.code || finalCode;
      summaryEl.textContent = `${existing.name || ''}ï½œ${existing.color || ''}ï½œ${existing.size || ''}ï½œ${existing.price || ''}ï½œ${existing.category || ''}`;
      statusEl.innerHTML = '<span style="color: red;">å•†å“ç·¨è™Ÿå·²å­˜åœ¨</span>';
      return;
    }

    statusEl.innerHTML = '<span style="color: green;">å·²æ–°å¢åˆ°å•†å“è¡¨</span>';
    loadProductNamesByCategory();
  }).catch(error => {
    statusEl.innerHTML = `<span style="color: red;">æ–°å¢å¤±æ•—: ${error.message}</span>`;
  });
}

async function loadProductNamesByCategory() {
  try {
    const categoryEl = document.getElementById('newProductCategory');
    const nameEl = document.getElementById('newProductName');
    const previousCategory = categoryEl ? categoryEl.value : '';
    const previousName = nameEl ? nameEl.value : '';
    const data = await apiCall('getProducts');
    if (data.error) {
      console.error('Error loading products:', data.error);
      return;
    }

    const products = Array.isArray(data) ? data : (data.products || []);
    window.cachedProducts = products;
    const index = buildProductNameIndex(products);

    const fallback = await apiCall("?action=get_sheet_data&sheet=ä»£è™Ÿåå–®&range=A2:B");
    const codeToName = {};
    if (fallback.values) {
      fallback.values.forEach(row => {
        const name = row[0] ? row[0].toString().trim() : '';
        const code = row[1] ? row[1].toString().trim() : '';
        if (code) {
          codeToName[code] = name || code;
        }
      });
    }

    window.categoryCodeNameMap = codeToName;

    let options = Object.keys(index);
    options = options.concat(Object.keys(codeToName));
    options = Array.from(new Set(options)).sort();

    categoryEl.innerHTML = '<option value="" selected>è«‹é¸æ“‡</option>' +
      options.map(code => {
        const label = codeToName[code] || code;
        return `<option value="${code}">${label}</option>`;
      }).join('');

    if (previousCategory) {
      categoryEl.value = previousCategory;
    }

    categoryEl.addEventListener('change', () => updateProductNameOptions(index));
    updateProductNameOptions(index);

    if (previousName && nameEl) {
      nameEl.value = previousName;
    }
  } catch (error) {
    console.error('Error loading product names:', error);
  }
}

// === Initialize ===
window.addEventListener('DOMContentLoaded', async () => {
  if (!token()) {
    window.location.href = 'index.html';
    return;
  }
  const typeEl = document.getElementById('createCodeType');
  const codeEl = document.getElementById('createCodeValue');
  updateCodeConstraints();
  typeEl.addEventListener('change', () => {
    updateCodeConstraints();
    normalizeCodeInput();
  });
  codeEl.addEventListener('input', normalizeCodeInput);
  await loadProductNamesByCategory();
  await loadReferenceMaps();
});

</script>

</body>
</html>
