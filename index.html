<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>訂單記錄工具</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      max-width: 100%;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f6f6f6;
    }
    *, *::before, *::after { box-sizing: border-box; }

    .container { padding: 14px; }
    h2 { font-size: 18px; margin-bottom: 12px; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 14px;
    }

    label { font-size: 13px; opacity: .8; }
    input, button, select {
      width: 100%;
      font-size: 16px;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    input[readonly] { background: #eee; }
    
    select {
      background: #fff;
    }

    .option-select {
      width: 60%;
      max-width: 150px;
    }

    .qty-input {
      width: 120px;
      max-width: 60%;
    }

    button {
      background: #111;
      color: #fff;
      border: none;
      margin-top: 12px;
    }

    button:hover {
      background: #333;
      cursor: pointer;
    }

    .status { font-size: 13px; margin-top: 8px; }
    
    .button-group {
      display: flex;
      gap: 8px;
      width: 100%;
    }
    
    .button-group button {
      flex: 1;
      margin: 0;
      margin-top: 12px;
    }
    
    .refresh-btn {
      background: #1e88e5;
      font-size: 13px;
      padding: 6px 10px;
      margin-top: 6px;
      width: auto;
      display: inline-block;
    }
    
    .refresh-btn:hover {
      background: #1976d2;
    }
    
    .small-refresh {
      font-size: 12px;
      padding: 4px 8px;
      margin-left: 8px;
      width: auto;
      display: inline-block;
      vertical-align: middle;
    }
    
    /* Login page styles */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #111;
    }
    
    .login-box {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 320px;
      margin: 16px;
    }
    
    .login-box h2 {
      color: #111;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .login-box input {
      margin-bottom: 10px;
    }
    
    .login-box button {
      background: #4CAF50;
    }
    
    .login-box button:hover {
      background: #45a049;
    }
    
    .login-box .status {
      text-align: center;
      color: #d32f2f;
    }
    
    /* Top navigation bar */
    .top-nav {
      position: fixed;
      top: 0;
      right: 0;
      padding: 10px;
      z-index: 1000;
      display: flex;
      gap: 8px;
    }
    
    .nav-btn {
      background: #4CAF50;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .nav-btn:hover {
      background: #45a049;
    }
  </style>
</head>

<body>

<!-- Top Navigation -->
<div id="topNav" class="top-nav" style="display:none;">
  <a href="deposit.html" class="nav-btn">匯款名單</a>
  <a href="additem.html" class="nav-btn">新增商品</a>
  <a href="report.html" class="nav-btn">報表</a>
</div>

<!-- Login Screen -->
<div id="loginScreen" class="login-container">
  <div class="login-box">
    <h2>登入</h2>
    <input id="pin" type="password" inputmode="numeric" placeholder="請輸入 PIN 碼">
    <button onclick="login()">登入</button>
    <div class="status" id="loginStatus"></div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" class="container" style="display:none;">

  <h2>訂單記錄</h2>

  <!-- 訂購人 -->
  <div class="card">
    <label>訂購人（必填）
      <button class="refresh-btn small-refresh" onclick="refreshBuyerList()">刷新</button>
    </label>
    <input id="buyer" placeholder="請輸入訂購人" list="buyerNames">
    <datalist id="buyerNames"></datalist>
  </div>

  <!-- 商品選擇 -->
  <div class="card">
    <label><strong>選擇商品方式：</strong></label>
    <label style="margin-top:10px; font-weight: normal;"> 商品編號</label>
    <input id="code" placeholder="例如 MB002UH" list="productCodes">
    <datalist id="productCodes"></datalist>

    <label style="margin-top:10px; font-weight: normal;">或 商品名稱（關鍵字）</label>
    <input id="name" placeholder="例如 小王子四季被" list="productNames">
    <datalist id="productNames"></datalist>
  </div>

  <!-- 數量 -->
  <div class="card">
    <label><strong>數量（必填）</strong></label>
    <input id="qty" class="qty-input" type="number" min="1" value="1">
  </div>

  <!-- 自訂欄位（可選） -->
  <div class="card">
    <label style="font-weight: normal; opacity: 0.6;">
      <button class="refresh-btn" onclick="refreshProductOptions()">刷新</button>
      點擊刷新選項<br>
    </label>
    
    <label style="margin-top:10px; font-weight: normal; opacity: 0.8;">顏色: </label>
    <select id="color" class="option-select">
      <option value="無">無</option>
    </select>

    <label style="margin-top:10px; font-weight: normal; opacity: 0.8;">大小: </label>
    <select id="size" class="option-select">
      <option value="無">無</option>
    </select>
  </div>

  <!-- 送出 -->
  <div class="card">
    <div class="button-group">
      <button onclick="submitOrder()">記錄</button>
      <button class="secondary" onclick="logout()" style="background: #666;">登出</button>
    </div>
    <div class="status" id="status"></div>
  </div>

</div>

<script src="common.js"></script>
<script>

function setStatus(msg) {
  const statusEl = document.getElementById('status') || document.getElementById('loginStatus');
  if (statusEl) statusEl.textContent = msg;
}

function showLogin() {
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("topNav").style.display = "none";
}

function showApp() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainApp").style.display = "block";
  document.getElementById("topNav").style.display = "block";
}

// === Login ===
async function login(){
  try {
    const res = await fetch(API_URL + "?login=1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin: pin.value })
    });

    const text = await res.text();   // ⭐ 關鍵：先用 text
    console.log("login raw response:", text);

    let data = {};
    try {
      data = JSON.parse(text);
    } catch {
      alert("後端回傳不是 JSON：" + text);
      return;
    }

    if (data.token) {
      localStorage.setItem("sessionToken", data.token);
      showApp();
      initializeApp();   // ✅ background load
    } else {
      alert("PIN 錯誤");
    }

  } catch(e) {
    alert("連線錯誤：" + e);
  }
}

function logout() { 
  localStorage.removeItem("sessionToken"); 
  showLogin(); 
}

// === Initialize App ===
async function initializeApp() {
  if (window.appInitialized) return;
  window.appInitialized = true;
  initializeProductAutocomplete();
  setupCodeAutocomplete();
  loadBuyerListInBackground();
  loadProductCodesInBackground();
}

function setupCodeAutocomplete() {
  const codeInput = document.getElementById('code');
  if (!codeInput || codeInput.dataset.autocompleteBound) return;
  codeInput.dataset.autocompleteBound = 'true';
  codeInput.addEventListener('focus', () => {
    loadProductCodesInBackground();
  });
  codeInput.addEventListener('input', () => {
    const value = codeInput.value.trim().toUpperCase();
    if (!isCompleteCode(value)) {
      window.lastAutoFilledCode = '';
      if (!value) {
        document.getElementById('name').value = '';
        setSelectValue(document.getElementById('color'), '無');
        setSelectValue(document.getElementById('size'), '無');
      }
      return;
    }
    if (value === window.lastAutoFilledCode) return;
    autoFillFromCode(value);
  });
}

function loadProductCodesInBackground(force = false, showStatus = false) {
  if (window.codeAutocompleteLoading) return;
  if (window.codeAutocompleteLoaded && !force) return;
  window.codeAutocompleteLoading = true;
  if (showStatus) setStatus('載入商品編號中...');

  apiCall("getProductCodes").then(codes => {
    window.cachedProductCodes = codes;
    const datalist = document.getElementById('productCodes');
    datalist.innerHTML = '';
    codes.forEach(code => {
      const option = document.createElement('option');
      option.value = code;
      datalist.appendChild(option);
    });
    window.codeAutocompleteLoaded = true;
  }).catch(() => {
    window.codeAutocompleteLoaded = false;
    if (showStatus) setStatus('載入商品編號失敗');
  }).finally(() => {
    window.codeAutocompleteLoading = false;
    if (showStatus) setTimeout(() => setStatus(''), 800);
  });
}

async function ensureProductCodesLoaded() {
  if (Array.isArray(window.cachedProductCodes) && window.cachedProductCodes.length > 0) {
    return window.cachedProductCodes;
  }
  const codes = await apiCall("getProductCodes");
  window.cachedProductCodes = codes;
  return codes;
}

async function ensureProductsLoaded() {
  if (Array.isArray(window.cachedProducts) && window.cachedProducts.length > 0) {
    return window.cachedProducts;
  }
  const products = await apiCall("getProducts");
  const list = Array.isArray(products) ? products : (products.products || []);
  window.cachedProducts = list;
  return list;
}

function isCompleteCode(code) {
  return /^[A-Z]{2}\d{3}[A-Z]{2}$/i.test(code);
}

function setSelectValue(selectEl, value) {
  if (!selectEl) return;
  const target = value || '無';
  const exists = Array.from(selectEl.options).some(option => option.value === target);
  if (!exists) {
    const option = document.createElement('option');
    option.value = target;
    option.textContent = target;
    selectEl.appendChild(option);
  }
  selectEl.value = target;
}

async function autoFillFromCode(code) {
  try {
    const products = await ensureProductsLoaded();
    const match = products.find(product =>
      (product.code || '').toUpperCase() === code
    );

    if (!match) {
      window.lastAutoFilledCode = '';
      return;
    }

    document.getElementById('name').value = match.name || '';
    setSelectValue(document.getElementById('color'), match.color || '');
    setSelectValue(document.getElementById('size'), match.size || '');
    window.lastAutoFilledCode = code;
  } catch (err) {
    console.error('自動帶入商品資訊失敗：', err);
  }
}

function loadBuyerListInBackground(force = false, showStatus = false) {
  if (window.buyerListLoading) return;
  if (window.buyerListLoaded && !force) return;
  window.buyerListLoading = true;
  if (showStatus) setStatus('重新載入訂購人列表中...');

  apiCall("getBuyerNames").then(buyers => {
    const datalist = document.getElementById('buyerNames');
    datalist.innerHTML = '';
    buyers.forEach(buyer => {
      const option = document.createElement('option');
      option.value = buyer;
      datalist.appendChild(option);
    });
    window.buyerListLoaded = true;
  }).catch(err => {
    console.error('取得訂購人列表失敗：', err);
  }).finally(() => {
    window.buyerListLoading = false;
    if (showStatus) setTimeout(() => setStatus(''), 1000);
  });
}

// === 重新載入訂購人列表 ===
async function refreshBuyerList() {
  loadBuyerListInBackground(true, true);
  loadProductCodesInBackground(false, false);
}

// === 初始化自動完成列表（唯一商品名稱）===
async function initializeProductAutocomplete() {
  try {
    const products = await apiCall("getProductNames");
    const datalist = document.getElementById('productNames');
    datalist.innerHTML = '';
    products.forEach(product => {
      const option = document.createElement('option');
      option.value = product;
      datalist.appendChild(option);
    });
  } catch (err) {
    console.error('取得商品列表失敗：', err);
  }
}

// === 重新載入顏色與大小選項（下拉式選單）===
async function refreshProductOptions() {
  const code = document.getElementById('code').value.trim();
  const name = document.getElementById('name').value.trim();
  
  if (!code && !name) {
    return setStatus('請先輸入商品編號或商品名稱');
  }
  
  // 檢查商品編號長度（至少5個字元才允許部分匹配）
  if (code && code.length < 5) {
    return setStatus('商品編號至少需要5個字元才能搜尋');
  }
  
  try {
    setStatus('載入中...');
    
    const params = new URLSearchParams();
    if (code) params.append('code', code);
    if (name) params.append('name', name);
    
    const options = await apiCall("getProductOptions&" + params.toString());
    
    // 更新顏色下拉選單
    const colorSelect = document.getElementById('color');
    colorSelect.innerHTML = '<option value="無">無</option>';
    options.colors.forEach(color => {
      const option = document.createElement('option');
      option.value = color;
      option.textContent = color;
      colorSelect.appendChild(option);
    });
    
    // 更新大小下拉選單
    const sizeSelect = document.getElementById('size');
    sizeSelect.innerHTML = '<option value="無">無</option>';
    options.sizes.forEach(size => {
      const option = document.createElement('option');
      option.value = size;
      option.textContent = size;
      sizeSelect.appendChild(option);
    });
    
    setStatus('已載入可選項目');
  } catch (err) {
    setStatus('錯誤：' + err.message);
  }
}

// === Submit Order ===
async function submitOrder() {
  const order = {
    buyer: document.getElementById('buyer').value.trim(),
    code: document.getElementById('code').value.trim(),
    name: document.getElementById('name').value.trim(),
    qty: Number(document.getElementById('qty').value),
    color: document.getElementById('color').value.trim(),
    size: document.getElementById('size').value.trim()
  };

  if (!order.buyer) {
    return setStatus('請輸入訂購人');
  }

  if (!order.qty || order.qty < 1) {
    return setStatus('請輸入有效的數量');
  }

  if (!order.code && !order.name) {
    return setStatus('請輸入商品編號或商品名稱');
  }

  try {
    if (order.code) {
      const normalizedCode = order.code.toUpperCase();
      if (isCompleteCode(normalizedCode)) {
        const codes = await ensureProductCodesLoaded();
        if (!codes.includes(normalizedCode)) {
          return setStatus('商品編號不存在，請確認');
        }
        order.code = normalizedCode;
        order.name = '';
        order.color = '';
        order.size = '';
      } else {
        order.code = '';
      }
    }

    if (!order.code) {
      if (!order.name || !order.color || !order.size || order.color === '無' || order.size === '無') {
        return setStatus('請輸入商品名稱、顏色與大小');
      }

      const products = await ensureProductsLoaded();
      const matched = products.some(product =>
        (product.name || '') === order.name &&
        (product.color || '') === order.color &&
        (product.size || '') === order.size
      );

      if (!matched) {
        return setStatus('商品名稱、顏色與大小無法匹配商品清單');
      }
    }

    setStatus('記錄中...');
    await apiCall("appendOrder", "POST", order);
    setStatus('已成功記錄');
    resetForm();
  } catch (err) {
    setStatus(err.message);
  }
}

// === Reset Form ===
function resetForm() {
  document.getElementById('code').value = '';
  document.getElementById('name').value = '';
  document.getElementById('color').innerHTML = '<option value="無">無</option>';
  document.getElementById('size').innerHTML = '<option value="無">無</option>';
  document.getElementById('qty').value = 1;
  document.getElementById('buyer').value = '';
}

// === Auto-login if token exists ===
window.addEventListener('load', function() {
  if (token()) {
    showApp();
    initializeApp();
  } else {
    showLogin();
  }
});

// Alternative: immediate check (backup method style)
if(token()){ showApp(); initializeApp(); } else showLogin();

</script>

</body>
</html>








