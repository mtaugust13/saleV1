<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è¨‚å–®è¨˜éŒ„å·¥å…·</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      max-width: 100%;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f6f6f6;
    }
    *, *::before, *::after { box-sizing: border-box; }

    .container { padding: 14px; }
    h2 { font-size: 18px; margin-bottom: 12px; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 14px;
    }

    label { font-size: 13px; opacity: .8; }
    input, button, select {
      width: 100%;
      font-size: 16px;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    input[readonly] { background: #eee; }
    
    select {
      background: #fff;
    }

    button {
      background: #111;
      color: #fff;
      border: none;
      margin-top: 12px;
    }

    button:hover {
      background: #333;
      cursor: pointer;
    }

    .status { font-size: 13px; margin-top: 8px; }
    
    .button-group {
      display: flex;
      gap: 8px;
      width: 100%;
    }
    
    .button-group button {
      flex: 1;
      margin: 0;
      margin-top: 12px;
    }
    
    .refresh-btn {
      background: #666;
      font-size: 13px;
      padding: 6px 10px;
      margin-top: 6px;
      width: auto;
      display: inline-block;
    }
    
    .refresh-btn:hover {
      background: #888;
    }
    
    .small-refresh {
      font-size: 12px;
      padding: 4px 8px;
      margin-left: 8px;
      width: auto;
      display: inline-block;
      vertical-align: middle;
    }
    
    /* Login page styles */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #111;
    }
    
    .login-box {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 320px;
      margin: 16px;
    }
    
    .login-box h2 {
      color: #111;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .login-box input {
      margin-bottom: 10px;
    }
    
    .login-box button {
      background: #4CAF50;
    }
    
    .login-box button:hover {
      background: #45a049;
    }
    
    .login-box .status {
      text-align: center;
      color: #d32f2f;
    }
  </style>
</head>

<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-container">
  <div class="login-box">
    <h2>ç™»å…¥</h2>
    <input id="pin" type="password" inputmode="numeric" placeholder="è«‹è¼¸å…¥ PIN ç¢¼">
    <button onclick="login()">ç™»å…¥</button>
    <div class="status" id="loginStatus"></div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" class="container" style="display:none;">

  <h2>è¨‚å–®è¨˜éŒ„</h2>

  <!-- è¨‚è³¼äºº -->
  <div class="card">
    <label>è¨‚è³¼äººï¼ˆå¿…å¡«ï¼‰
      <button class="refresh-btn small-refresh" onclick="refreshBuyerList()">ğŸ”„</button>
    </label>
    <input id="buyer" placeholder="è«‹è¼¸å…¥è¨‚è³¼äºº" list="buyerNames">
    <datalist id="buyerNames"></datalist>
  </div>

  <!-- å•†å“é¸æ“‡ -->
  <div class="card">
    <label><strong>é¸æ“‡å•†å“æ–¹å¼ï¼š</strong></label>
    <label style="margin-top:10px; font-weight: normal;">âœ“ å•†å“ç·¨è™Ÿï¼ˆæ¨è–¦ï¼‰</label>
    <input id="code" placeholder="ä¾‹å¦‚ A001">

    <label style="margin-top:10px; font-weight: normal;">æˆ– å•†å“åç¨±ï¼ˆé—œéµå­—ï¼‰</label>
    <input id="name" placeholder="ä¾‹å¦‚ å’–å•¡" list="productNames">
    <datalist id="productNames"></datalist>
  </div>

  <!-- æ•¸é‡ -->
  <div class="card">
    <label><strong>æ•¸é‡ï¼ˆå¿…å¡«ï¼‰</strong></label>
    <input id="qty" type="number" min="1" value="1">
  </div>

  <!-- è‡ªè¨‚æ¬„ä½ï¼ˆå¯é¸ï¼‰ -->
  <div class="card">
    <label style="font-weight: normal; opacity: 0.6;">
      é»æ“Šã€ŒğŸ”„ã€æŒ‰éˆ•ä»¥é¡¯ç¤ºå¯é¸çš„é¡è‰²èˆ‡å¤§å°
      <button class="refresh-btn" onclick="refreshProductOptions()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </label>
    
    <label style="margin-top:10px; font-weight: normal; opacity: 0.8;">é¡è‰²ï¼ˆå¯ä¸å¡«ï¼‰</label>
    <select id="color">
      <option value="">-- è«‹å…ˆè¼‰å…¥é¸é … --</option>
    </select>

    <label style="margin-top:10px; font-weight: normal; opacity: 0.8;">å¤§å°ï¼ˆå¯ä¸å¡«ï¼‰</label>
    <select id="size">
      <option value="">-- è«‹å…ˆè¼‰å…¥é¸é … --</option>
    </select>
  </div>

  <!-- é€å‡º -->
  <div class="card">
    <div class="button-group">
      <button onclick="submitOrder()">è¨˜éŒ„</button>
      <button class="secondary" onclick="logout()" style="background: #666;">ç™»å‡º</button>
    </div>
    <div class="status" id="status"></div>
  </div>

</div>

<script>

const API_URL = "https://sales-v1-api-26316719641.asia-east1.run.app"; // â† è«‹æ”¹æˆæ‚¨çš„ Cloud Run URL

// === Helper Functions ===
function token() { 
  return localStorage.getItem("sessionToken"); 
}

function setStatus(msg) {
  const statusEl = document.getElementById('status') || document.getElementById('loginStatus');
  if (statusEl) statusEl.textContent = msg;
}

function showLogin() {
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("mainApp").style.display = "none";
}

function showApp() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainApp").style.display = "block";
}

// === API Functions ===
async function apiCall(action, method = "GET", body = null) {
  const options = {
    method: method,
    headers: {
      "Content-Type": "application/json",
      "x-session-token": token()
    }
  };
  
  if (body) {
    options.body = JSON.stringify(body);
  }
  
  const url = action.startsWith("?") ? API_URL + action : API_URL + "?action=" + action;
  const res = await fetch(url, options);
  
  if (!res.ok) {
    const errorData = await res.json().catch(() => ({ error: "Unknown error" }));
    throw new Error(errorData.error || "Request failed");
  }
  
  return await res.json();
}

// === Login ===
async function login() {
  const pinInput = document.getElementById('pin');
  
  if (!pinInput.value) {
    setStatus('è«‹è¼¸å…¥ PIN ç¢¼');
    return;
  }
  
  try {
    setStatus('ç™»å…¥ä¸­...');
    
    const res = await fetch(API_URL + "?login=1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin: pinInput.value })
    });

    
    if (data.token) {
      localStorage.setItem("sessionToken", data.token);
      setStatus('ç™»å…¥æˆåŠŸ');
      showApp();
      await initializeApp();
    } else {
      setStatus('PIN éŒ¯èª¤');
    }

  } catch(e) {
    setStatus('é€£ç·šéŒ¯èª¤ï¼š' + e.message);
  }
}

function logout() { 
  localStorage.removeItem("sessionToken"); 
  showLogin(); 
}

// === Initialize App ===
async function initializeApp() {
  await initializeBuyerAutocomplete();
  await initializeProductAutocomplete();
}

// === åˆå§‹åŒ–è¨‚è³¼äººè‡ªå‹•å®Œæˆåˆ—è¡¨ ===
async function initializeBuyerAutocomplete() {
  try {
    const buyers = await apiCall("getBuyerNames");
    const datalist = document.getElementById('buyerNames');
    datalist.innerHTML = '';
    buyers.forEach(buyer => {
      const option = document.createElement('option');
      option.value = buyer;
      datalist.appendChild(option);
    });
  } catch (err) {
    console.error('å–å¾—è¨‚è³¼äººåˆ—è¡¨å¤±æ•—ï¼š', err);
  }
}

// === é‡æ–°è¼‰å…¥è¨‚è³¼äººåˆ—è¡¨ ===
async function refreshBuyerList() {
  setStatus('é‡æ–°è¼‰å…¥è¨‚è³¼äººåˆ—è¡¨ä¸­...');
  await initializeBuyerAutocomplete();
  setTimeout(() => setStatus(''), 1000);
}

// === åˆå§‹åŒ–è‡ªå‹•å®Œæˆåˆ—è¡¨ï¼ˆå”¯ä¸€å•†å“åç¨±ï¼‰===
async function initializeProductAutocomplete() {
  try {
    const products = await apiCall("getProductNames");
    const datalist = document.getElementById('productNames');
    datalist.innerHTML = '';
    products.forEach(product => {
      const option = document.createElement('option');
      option.value = product;
      datalist.appendChild(option);
    });
  } catch (err) {
    console.error('å–å¾—å•†å“åˆ—è¡¨å¤±æ•—ï¼š', err);
  }
}

// === é‡æ–°è¼‰å…¥é¡è‰²èˆ‡å¤§å°é¸é …ï¼ˆä¸‹æ‹‰å¼é¸å–®ï¼‰===
async function refreshProductOptions() {
  const code = document.getElementById('code').value.trim();
  const name = document.getElementById('name').value.trim();
  
  if (!code && !name) {
    return setStatus('è«‹å…ˆè¼¸å…¥å•†å“ç·¨è™Ÿæˆ–å•†å“åç¨±');
  }
  
  // æª¢æŸ¥å•†å“ç·¨è™Ÿé•·åº¦ï¼ˆè‡³å°‘5å€‹å­—å…ƒæ‰å…è¨±éƒ¨åˆ†åŒ¹é…ï¼‰
  if (code && code.length < 5) {
    return setStatus('å•†å“ç·¨è™Ÿè‡³å°‘éœ€è¦5å€‹å­—å…ƒæ‰èƒ½æœå°‹');
  }
  
  try {
    setStatus('è¼‰å…¥ä¸­...');
    
    const params = new URLSearchParams();
    if (code) params.append('code', code);
    if (name) params.append('name', name);
    
    const options = await apiCall("getProductOptions&" + params.toString());
    
    // æ›´æ–°é¡è‰²ä¸‹æ‹‰é¸å–®
    const colorSelect = document.getElementById('color');
    colorSelect.innerHTML = '<option value="">-- ä¸é¸æ“‡ --</option>';
    options.colors.forEach(color => {
      const option = document.createElement('option');
      option.value = color;
      option.textContent = color;
      colorSelect.appendChild(option);
    });
    
    // æ›´æ–°å¤§å°ä¸‹æ‹‰é¸å–®
    const sizeSelect = document.getElementById('size');
    sizeSelect.innerHTML = '<option value="">-- ä¸é¸æ“‡ --</option>';
    options.sizes.forEach(size => {
      const option = document.createElement('option');
      option.value = size;
      option.textContent = size;
      sizeSelect.appendChild(option);
    });
    
    setStatus('å·²è¼‰å…¥å¯é¸é …ç›®');
  } catch (err) {
    setStatus('éŒ¯èª¤ï¼š' + err.message);
  }
}

// === Submit Order ===
async function submitOrder() {
  const order = {
    buyer: document.getElementById('buyer').value.trim(),
    code: document.getElementById('code').value.trim(),
    name: document.getElementById('name').value.trim(),
    qty: Number(document.getElementById('qty').value),
    color: document.getElementById('color').value.trim(),
    size: document.getElementById('size').value.trim()
  };

  if (!order.buyer) {
    return setStatus('è«‹è¼¸å…¥è¨‚è³¼äºº');
  }

  if (!order.qty || order.qty < 1) {
    return setStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡');
  }

  if (!order.code && !order.name) {
    return setStatus('è«‹è¼¸å…¥å•†å“ç·¨è™Ÿæˆ–å•†å“åç¨±');
  }

  try {
    setStatus('è¨˜éŒ„ä¸­...');
    await apiCall("appendOrder", "POST", order);
    setStatus('å·²æˆåŠŸè¨˜éŒ„');
    resetForm();
  } catch (err) {
    setStatus(err.message);
  }
}

// === Reset Form ===
function resetForm() {
  document.getElementById('code').value = '';
  document.getElementById('name').value = '';
  document.getElementById('color').innerHTML = '<option value="">-- è«‹å…ˆè¼‰å…¥é¸é … --</option>';
  document.getElementById('size').innerHTML = '<option value="">-- è«‹å…ˆè¼‰å…¥é¸é … --</option>';
  document.getElementById('qty').value = 1;
  document.getElementById('buyer').value = '';
}

// === Auto-login if token exists ===
window.addEventListener('load', function() {
  if (token()) {
    showApp();
    initializeApp();
  } else {
    showLogin();
  }
});

</script>

</body>
</html>








